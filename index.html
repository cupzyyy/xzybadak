<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Chat Panel - WA Badak Pro</title>
  <style>
    /* Admin Chat Styles */
    .admin-chat-container {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 20px;
      height: 100vh;
      padding: 20px;
      background: #0f172a;
    }
    
    .chat-list {
      background: #1e293b;
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .chat-list-header {
      padding: 20px;
      background: #25d366;
      color: white;
      font-weight: 700;
      font-size: 18px;
    }
    
    .chat-search {
      padding: 15px;
      background: #334155;
    }
    
    .chat-search-input {
      width: 100%;
      padding: 10px 15px;
      border-radius: 8px;
      border: none;
      background: #475569;
      color: white;
    }
    
    .chat-items {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }
    
    .chat-item {
      padding: 15px;
      background: #475569;
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s;
      border-left: 4px solid #25d366;
    }
    
    .chat-item:hover {
      background: #4b5563;
    }
    
    .chat-item.active {
      background: #1d4ed8;
    }
    
    .chat-item-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    
    .chat-user-name {
      font-weight: 700;
      color: white;
    }
    
    .chat-time {
      font-size: 12px;
      color: #9ca3af;
    }
    
    .chat-preview {
      font-size: 13px;
      color: #d1d5db;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .chat-unread {
      background: #ef4444;
      color: white;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 10px;
      margin-top: 5px;
    }
    
    .chat-panel {
      background: #1e293b;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .chat-panel-header {
      padding: 20px;
      background: #334155;
      color: white;
      font-weight: 700;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .chat-messages-container {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .chat-input-container {
      padding: 20px;
      background: #334155;
      display: flex;
      gap: 10px;
    }
    
    .admin-message-input {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #4b5563;
      background: #475569;
      color: white;
      resize: none;
    }
    
    .admin-send-btn {
      background: #25d366;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
    }
    
    .no-chat-selected {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #9ca3af;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="admin-chat-container" id="adminChatContainer">
    <!-- Chat list sidebar -->
    <div class="chat-list">
      <div class="chat-list-header">
        ðŸ’¬ Admin Chat Panel
      </div>
      <div class="chat-search">
        <input type="text" class="chat-search-input" placeholder="Cari user..." id="chatSearch">
      </div>
      <div class="chat-items" id="chatItems">
        <!-- Chats will be loaded here -->
      </div>
    </div>
    
    <!-- Chat panel -->
    <div class="chat-panel">
      <div class="chat-panel-header" id="currentChatHeader">
        <span id="currentUserName">Pilih percakapan</span>
        <button onclick="closeCurrentChat()" style="background:#ef4444;color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;">
          Tutup Chat
        </button>
      </div>
      
      <div class="chat-messages-container" id="adminChatMessages">
        <div class="no-chat-selected">
          <div>
            <i class="fas fa-comments fa-3x" style="margin-bottom:20px;"></i><br>
            Pilih percakapan dari daftar di sebelah kiri
          </div>
        </div>
      </div>
      
      <div class="chat-input-container" id="adminChatInput" style="display:none;">
        <textarea class="admin-message-input" id="adminMessageInput" placeholder="Ketik balasan..." rows="2"></textarea>
        <button class="admin-send-btn" onclick="sendAdminMessage()">
          Kirim
        </button>
      </div>
    </div>
  </div>
  
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCf230zCliSZ9EYLByMnmflqw8sOz328Uc",
      authDomain: "database-cupz.firebaseapp.com",
      projectId: "database-cupz",
      storageBucket: "database-cupz.firebasestorage.app",
      messagingSenderId: "343357519412",
      appId: "1:343357519412:web:dce862636c7c459e6a3c61"
    };
    
    // Initialize
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    let currentAdmin = null;
    let currentChatId = null;
    let chatListener = null;
    
    // Check admin auth
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists && userDoc.data().role === 'admin') {
          currentAdmin = user;
          loadChats();
          setupRealTimeListeners();
          
          // Update admin online status
          await db.collection('users').doc(user.uid).update({
            lastActive: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          setInterval(async () => {
            await db.collection('users').doc(user.uid).update({
              lastActive: firebase.firestore.FieldValue.serverTimestamp()
            });
          }, 60000); // Update every minute
          
        } else {
          window.location.href = 'index.html';
        }
      } else {
        window.location.href = 'index.html';
      }
    });
    
    // Load all active chats
    async function loadChats() {
      const chatsRef = db.collection('chats')
        .where('status', 'in', ['pending', 'active'])
        .orderBy('lastMessageTime', 'desc');
      
      const snapshot = await chatsRef.get();
      const container = document.getElementById('chatItems');
      
      if (snapshot.empty) {
        container.innerHTML = '<div style="padding:20px;color:#9ca3af;text-align:center;">Belum ada chat</div>';
        return;
      }
      
      let html = '';
      snapshot.forEach(doc => {
        const chat = doc.data();
        const time = chat.lastMessageTime?.toDate() || new Date();
        const formattedTime = time.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
        
        html += `
          <div class="chat-item" onclick="selectChat('${doc.id}', '${chat.userName}', '${chat.userEmail}')" 
               data-chat-id="${doc.id}">
            <div class="chat-item-header">
              <div class="chat-user-name">${chat.userName}</div>
              <div class="chat-time">${formattedTime}</div>
            </div>
            <div class="chat-preview">${chat.lastMessage}</div>
            ${chat.adminUnread > 0 ? `<div class="chat-unread">${chat.adminUnread} new</div>` : ''}
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    // Select a chat
    function selectChat(chatId, userName, userEmail) {
      currentChatId = chatId;
      
      // Update UI
      document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.chatId === chatId) {
          item.classList.add('active');
        }
      });
      
      document.getElementById('currentUserName').textContent = `${userName} (${userEmail})`;
      document.getElementById('adminChatInput').style.display = 'flex';
      
      // Load messages for this chat
      loadChatMessages(chatId);
      
      // Mark admin messages as read
      markMessagesAsRead(chatId);
      
      // Update chat status
      db.collection('chats').doc(chatId).update({
        adminUnread: 0,
        adminId: currentAdmin.uid,
        adminName: currentAdmin.email,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    
    // Load chat messages
    async function loadChatMessages(chatId) {
      const messagesRef = db.collection('chat_messages')
        .where('chatId', '==', chatId)
        .orderBy('timestamp', 'asc');
      
      const snapshot = await messagesRef.get();
      const container = document.getElementById('adminChatMessages');
      
      let html = '';
      snapshot.forEach(doc => {
        const msg = doc.data();
        const time = msg.timestamp?.toDate() || new Date();
        const formattedTime = time.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
        
        const isAdmin = msg.senderRole === 'admin';
        const isSystem = msg.senderRole === 'system';
        
        if (isSystem) {
          html += `<div style="text-align:center;color:#9ca3af;font-size:12px;margin:10px 0;">${msg.message}</div>`;
        } else {
          html += `
            <div style="display:flex;${isAdmin ? 'justify-content:flex-end' : 'justify-content:flex-start'}">
              <div style="
                background: ${isAdmin ? '#25d366' : '#475569'};
                color: white;
                padding: 10px 15px;
                border-radius: 15px;
                max-width: 70%;
                margin-bottom: 5px;
              ">
                <div style="font-size:12px;margin-bottom:3px;">${msg.senderName}</div>
                <div>${msg.message}</div>
                <div style="font-size:10px;text-align:right;margin-top:5px;">${formattedTime}</div>
              </div>
            </div>
          `;
        }
      });
      
      container.innerHTML = html;
      container.scrollTop = container.scrollHeight;
    }
    
    // Send message as admin
    async function sendAdminMessage() {
      if (!currentChatId || !currentAdmin) return;
      
      const input = document.getElementById('adminMessageInput');
      const message = input.value.trim();
      
      if (!message) return;
      
      try {
        await db.collection('chat_messages').add({
          chatId: currentChatId,
          senderId: currentAdmin.uid,
          senderName: currentAdmin.email.split('@')[0],
          senderRole: 'admin',
          message: message,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          read: false,
          type: 'text'
        });
        
        // Update chat
        await db.collection('chats').doc(currentChatId).update({
          lastMessage: message.length > 30 ? message.substring(0, 30) + '...' : message,
          lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          userUnread: firebase.firestore.FieldValue.increment(1)
        });
        
        // Clear input
        input.value = '';
        
        // Reload messages
        loadChatMessages(currentChatId);
        
      } catch (error) {
        console.error('Error sending message:', error);
        alert('Gagal mengirim pesan: ' + error.message);
      }
    }
    
    // Mark messages as read
    async function markMessagesAsRead(chatId) {
      const messagesRef = db.collection('chat_messages')
        .where('chatId', '==', chatId)
        .where('senderRole', '==', 'user')
        .where('read', '==', false);
      
      const snapshot = await messagesRef.get();
      const batch = db.batch();
      
      snapshot.forEach(doc => {
        batch.update(doc.ref, { read: true });
      });
      
      await batch.commit();
    }
    
    // Close current chat
    function closeCurrentChat() {
      if (!currentChatId) return;
      
      if (confirm('Tutup chat ini?')) {
        db.collection('chats').doc(currentChatId).update({
          status: 'closed',
          closedAt: firebase.firestore.FieldValue.serverTimestamp(),
          closedBy: currentAdmin.uid
        });
        
        currentChatId = null;
        document.getElementById('adminChatInput').style.display = 'none';
        document.getElementById('currentUserName').textContent = 'Pilih percakapan';
        document.getElementById('adminChatMessages').innerHTML = `
          <div class="no-chat-selected">
            <div>
              <i class="fas fa-comments fa-3x" style="margin-bottom:20px;"></i><br>
              Pilih percakapan dari daftar di sebelah kiri
            </div>
          </div>
        `;
        
        loadChats();
      }
    }
    
    // Setup real-time listeners
    function setupRealTimeListeners() {
      // Listen for new chats
      db.collection('chats')
        .where('status', 'in', ['pending', 'active'])
        .onSnapshot((snapshot) => {
          loadChats();
        });
      
      // Listen for new messages in current chat
      if (currentChatId) {
        chatListener = db.collection('chat_messages')
          .where('chatId', '==', currentChatId)
          .orderBy('timestamp', 'asc')
          .onSnapshot((snapshot) => {
            loadChatMessages(currentChatId);
          });
      }
    }
    
    // Handle Enter key for sending
    document.getElementById('adminMessageInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendAdminMessage();
      }
    });
    
    // Search functionality
    document.getElementById('chatSearch').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      document.querySelectorAll('.chat-item').forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(searchTerm) ? 'block' : 'none';
      });
    });
    
    // Logout function
    function adminLogout() {
      if (confirm('Logout dari admin panel?')) {
        auth.signOut();
      }
    }
    
    // Add logout button to header
    const header = document.querySelector('.chat-panel-header');
    const logoutBtn = document.createElement('button');
    logoutBtn.textContent = 'Logout';
    logoutBtn.style.background = '#ef4444';
    logoutBtn.style.color = 'white';
    logoutBtn.style.border = 'none';
    logoutBtn.style.padding = '8px 15px';
    logoutBtn.style.borderRadius = '5px';
    logoutBtn.style.cursor = 'pointer';
    logoutBtn.style.marginLeft = '10px';
    logoutBtn.onclick = adminLogout;
    header.appendChild(logoutBtn);
  </script>
</body>
</html>