<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WA BADAK PRO - ADMIN PANEL</title>
  
  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <!-- FONT AWESOME -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- GOOGLE FONT -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <style>
    /* ========== CYLEX ADMIN RESET ========== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #0f172a, #1e293b);
      color: white;
      min-height: 100vh;
    }
    
    /* ========== ADMIN CONTAINER ========== */
    .admin-container {
      display: flex;
      min-height: 100vh;
    }
    
    /* ========== SIDEBAR ========== */
    .admin-sidebar {
      width: 250px;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(20px);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      padding: 25px 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }
    
    .admin-logo {
      text-align: center;
      padding: 0 20px 30px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 25px;
    }
    
    .admin-logo i {
      font-size: 40px;
      color: #25D366;
      margin-bottom: 10px;
    }
    
    .admin-logo h1 {
      font-size: 20px;
      font-weight: 900;
      color: white;
    }
    
    .admin-logo p {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
      margin-top: 5px;
    }
    
    .admin-menu {
      padding: 0 20px;
    }
    
    .admin-menu-item {
      display: flex;
      align-items: center;
      padding: 15px;
      color: rgba(255, 255, 255, 0.7);
      text-decoration: none;
      border-radius: 12px;
      margin-bottom: 10px;
      transition: all 0.3s;
      cursor: pointer;
    }
    
    .admin-menu-item:hover {
      background: rgba(37, 211, 102, 0.1);
      color: white;
    }
    
    .admin-menu-item.active {
      background: linear-gradient(135deg, #25D366, #128C7E);
      color: white;
      box-shadow: 0 5px 15px rgba(37, 211, 102, 0.3);
    }
    
    .admin-menu-icon {
      font-size: 18px;
      margin-right: 12px;
      width: 24px;
      text-align: center;
    }
    
    .admin-menu-text {
      font-size: 14px;
      font-weight: 600;
    }
    
    .admin-menu-badge {
      background: #EF4444;
      color: white;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 20px;
      margin-left: auto;
    }
    
    /* ========== MAIN CONTENT ========== */
    .admin-main {
      flex: 1;
      margin-left: 250px;
      padding: 30px;
    }
    
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .admin-title {
      font-size: 24px;
      font-weight: 800;
    }
    
    .admin-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .admin-stat-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 25px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s;
    }
    
    .admin-stat-card:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-5px);
    }
    
    .admin-stat-icon {
      font-size: 32px;
      margin-bottom: 15px;
    }
    
    .admin-stat-number {
      font-size: 32px;
      font-weight: 900;
      margin-bottom: 5px;
    }
    
    .admin-stat-label {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
    }
    
    /* ========== TABLES ========== */
    .admin-table-container {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 30px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      overflow-x: auto;
    }
    
    .admin-table-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th {
      text-align: left;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      font-weight: 600;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.9);
      border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    }
    
    td {
      padding: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 13px;
    }
    
    tr:hover {
      background: rgba(255, 255, 255, 0.03);
    }
    
    /* ========== BADGES ========== */
    .status-badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-pending {
      background: rgba(245, 158, 11, 0.2);
      color: #FBBF24;
    }
    
    .status-approved {
      background: rgba(34, 197, 94, 0.2);
      color: #86EFAC;
    }
    
    .status-rejected {
      background: rgba(239, 68, 68, 0.2);
      color: #FCA5A5;
    }
    
    .status-active {
      background: rgba(37, 211, 102, 0.2);
      color: #86EFAC;
    }
    
    .status-inactive {
      background: rgba(107, 114, 128, 0.2);
      color: #9CA3AF;
    }
    
    /* ========== BUTTONS ========== */
    .admin-btn {
      padding: 8px 16px;
      border-radius: 10px;
      border: none;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-right: 5px;
    }
    
    .admin-btn-success {
      background: #10B981;
      color: white;
    }
    
    .admin-btn-danger {
      background: #EF4444;
      color: white;
    }
    
    .admin-btn-warning {
      background: #F59E0B;
      color: white;
    }
    
    .admin-btn-info {
      background: #3B82F6;
      color: white;
    }
    
    .admin-btn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
    
    /* ========== MODALS ========== */
    .admin-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .admin-modal-content {
      background: linear-gradient(135deg, #1e293b, #0f172a);
      border-radius: 20px;
      padding: 30px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      border: 2px solid #25D366;
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
    }
    
    .admin-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .admin-modal-title {
      font-size: 20px;
      font-weight: 800;
    }
    
    .admin-modal-close {
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.5);
      font-size: 24px;
      cursor: pointer;
    }
    
    .admin-input-group {
      margin-bottom: 20px;
    }
    
    .admin-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
    }
    
    .admin-input {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      color: white;
      font-size: 14px;
    }
    
    .admin-input:focus {
      outline: none;
      border-color: #25D366;
    }
    
    .admin-textarea {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      color: white;
      font-size: 14px;
      resize: vertical;
      min-height: 100px;
    }
    
    /* ========== CHAT MODAL ========== */
    .admin-chat-modal {
      max-width: 800px;
      height: 80vh;
      display: flex;
      flex-direction: column;
    }
    
    .admin-chat-header {
      padding: 20px;
      background: linear-gradient(135deg, #25D366, #128C7E);
      border-radius: 15px 15px 0 0;
    }
    
    .admin-chat-user {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 10px;
    }
    
    .admin-chat-avatar {
      width: 50px;
      height: 50px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 700;
    }
    
    .admin-chat-info h4 {
      font-size: 16px;
      font-weight: 700;
    }
    
    .admin-chat-info p {
      font-size: 12px;
      opacity: 0.9;
    }
    
    .admin-chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.2);
    }
    
    .admin-message {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 18px;
      margin-bottom: 15px;
      position: relative;
    }
    
    .admin-message-user {
      background: rgba(255, 255, 255, 0.1);
      align-self: flex-start;
      border-bottom-left-radius: 5px;
    }
    
    .admin-message-admin {
      background: linear-gradient(135deg, #25D366, #128C7E);
      align-self: flex-end;
      border-bottom-right-radius: 5px;
    }
    
    .admin-chat-input {
      padding: 20px;
      background: rgba(0, 0, 0, 0.3);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      gap: 10px;
    }
    
    .admin-chat-input textarea {
      flex: 1;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      color: white;
      resize: none;
      height: 50px;
    }
    
    /* ========== NOTIFICATIONS ========== */
    .admin-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 12px;
      z-index: 9999;
      animation: slideIn 0.3s;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .notification-success {
      background: #10B981;
      color: white;
    }
    
    .notification-error {
      background: #EF4444;
      color: white;
    }
    
    .notification-warning {
      background: #F59E0B;
      color: white;
    }
    
    /* ========== LOADING ========== */
    .admin-loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ========== RESPONSIVE ========== */
    @media (max-width: 1024px) {
      .admin-sidebar {
        width: 70px;
      }
      
      .admin-sidebar .admin-menu-text,
      .admin-logo h1,
      .admin-logo p {
        display: none;
      }
      
      .admin-main {
        margin-left: 70px;
      }
      
      .admin-stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      .admin-stats {
        grid-template-columns: 1fr;
      }
      
      .admin-main {
        padding: 20px;
      }
    }
  </style>
</head>
<body>

<div class="admin-container">
  <!-- SIDEBAR -->
  <div class="admin-sidebar">
    <div class="admin-logo">
      <i class="fab fa-whatsapp"></i>
      <h1>WA BADAK PRO</h1>
      <p>ADMIN PANEL v3.0</p>
    </div>
    
    <div class="admin-menu">
      <div class="admin-menu-item active" onclick="showSection('dashboard')">
        <span class="admin-menu-icon"><i class="fas fa-tachometer-alt"></i></span>
        <span class="admin-menu-text">Dashboard</span>
      </div>
      
      <div class="admin-menu-item" onclick="showSection('users')">
        <span class="admin-menu-icon"><i class="fas fa-users"></i></span>
        <span class="admin-menu-text">Users</span>
        <span class="admin-menu-badge" id="usersBadge">0</span>
      </div>
      
      <div class="admin-menu-item" onclick="showSection('withdrawals')">
        <span class="admin-menu-icon"><i class="fas fa-money-bill-wave"></i></span>
        <span class="admin-menu-text">Withdrawals</span>
        <span class="admin-menu-badge" id="withdrawalsBadge">0</span>
      </div>
      
      <div class="admin-menu-item" onclick="showSection('chats')">
        <span class="admin-menu-icon"><i class="fas fa-comments"></i></span>
        <span class="admin-menu-text">Live Chats</span>
        <span class="admin-menu-badge" id="chatsBadge">0</span>
      </div>
      
      <div class="admin-menu-item" onclick="showSection('badak')">
        <span class="admin-menu-icon"><i class="fab fa-whatsapp"></i></span>
        <span class="admin-menu-text">Badak Numbers</span>
      </div>
      
      <div class="admin-menu-item" onclick="showSection('referrals')">
        <span class="admin-menu-icon"><i class="fas fa-user-friends"></i></span>
        <span class="admin-menu-text">Referrals</span>
      </div>
      
      <div class="admin-menu-item" onclick="showSection('broadcast')">
        <span class="admin-menu-icon"><i class="fas fa-bullhorn"></i></span>
        <span class="admin-menu-text">Broadcast</span>
      </div>
      
      <div class="admin-menu-item" onclick="showSection('settings')">
        <span class="admin-menu-icon"><i class="fas fa-cog"></i></span>
        <span class="admin-menu-text">Settings</span>
      </div>
      
      <div class="admin-menu-item" onclick="adminLogout()" style="margin-top: 30px; color: #EF4444;">
        <span class="admin-menu-icon"><i class="fas fa-sign-out-alt"></i></span>
        <span class="admin-menu-text">Logout</span>
      </div>
    </div>
  </div>
  
  <!-- MAIN CONTENT -->
  <div class="admin-main">
    <!-- HEADER -->
    <div class="admin-header">
      <div>
        <h1 class="admin-title" id="sectionTitle">Dashboard</h1>
        <p id="sectionSubtitle" style="color: rgba(255,255,255,0.7); font-size: 14px; margin-top: 5px;">
          Welcome back, Admin!
        </p>
      </div>
      <div style="display: flex; align-items: center; gap: 15px;">
        <div style="text-align: right;">
          <div style="font-weight: 600;" id="adminName">Loading...</div>
          <div style="font-size: 12px; color: rgba(255,255,255,0.7);" id="adminEmail">admin@wa-badak.com</div>
        </div>
        <div style="width: 45px; height: 45px; background: linear-gradient(135deg, #25D366, #128C7E); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 18px;" id="adminAvatar">
          A
        </div>
      </div>
    </div>
    
    <!-- DASHBOARD SECTION -->
    <div id="dashboardSection">
      <!-- STATS -->
      <div class="admin-stats">
        <div class="admin-stat-card">
          <div class="admin-stat-icon" style="color: #25D366;">
            <i class="fas fa-users"></i>
          </div>
          <div class="admin-stat-number" id="totalUsers">0</div>
          <div class="admin-stat-label">Total Users</div>
        </div>
        
        <div class="admin-stat-card">
          <div class="admin-stat-icon" style="color: #FBBF24;">
            <i class="fas fa-money-bill-wave"></i>
          </div>
          <div class="admin-stat-number" id="totalBalance">Rp0</div>
          <div class="admin-stat-label">Total Saldo</div>
        </div>
        
        <div class="admin-stat-card">
          <div class="admin-stat-icon" style="color: #8B5CF6;">
            <i class="fas fa-exchange-alt"></i>
          </div>
          <div class="admin-stat-number" id="pendingWithdrawals">0</div>
          <div class="admin-stat-label">Pending Withdrawals</div>
        </div>
        
        <div class="admin-stat-card">
          <div class="admin-stat-icon" style="color: #EF4444;">
            <i class="fas fa-comment-alt"></i>
          </div>
          <div class="admin-stat-number" id="unreadChats">0</div>
          <div class="admin-stat-label">Unread Chats</div>
        </div>
      </div>
      
      <!-- RECENT ACTIVITIES -->
      <div class="admin-table-container">
        <div class="admin-table-title">
          <i class="fas fa-history"></i> Recent Activities
        </div>
        <div id="recentActivities">
          Loading activities...
        </div>
      </div>
      
      <!-- QUICK ACTIONS -->
      <div class="admin-table-container">
        <div class="admin-table-title">
          <i class="fas fa-bolt"></i> Quick Actions
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
          <button class="admin-btn admin-btn-success" onclick="showModal('broadcastModal')">
            <i class="fas fa-bullhorn"></i> Send Broadcast
          </button>
          <button class="admin-btn admin-btn-info" onclick="showSection('withdrawals')">
            <i class="fas fa-money-bill-wave"></i> Process Withdrawals
          </button>
          <button class="admin-btn admin-btn-warning" onclick="showSection('chats')">
            <i class="fas fa-comments"></i> Reply Chats
          </button>
          <button class="admin-btn" style="background: #8B5CF6; color: white;" onclick="showModal('addBalanceModal')">
            <i class="fas fa-plus-circle"></i> Add Balance
          </button>
        </div>
      </div>
    </div>
    
    <!-- USERS SECTION -->
    <div id="usersSection" style="display: none;">
      <div class="admin-table-container">
        <div class="admin-table-title">
          <i class="fas fa-users"></i> All Users
          <div style="margin-left: auto; display: flex; gap: 10px;">
            <input type="text" id="searchUsers" class="admin-input" placeholder="Search users..." style="width: 200px;">
            <button class="admin-btn admin-btn-success" onclick="exportUsers()">
              <i class="fas fa-download"></i> Export
            </button>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>Email</th>
              <th>Balance</th>
              <th>Referrals</th>
              <th>Status</th>
              <th>Joined</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersTable">
            <tr><td colspan="6" style="text-align: center; padding: 40px;">Loading users...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- WITHDRAWALS SECTION -->
    <div id="withdrawalsSection" style="display: none;">
      <div class="admin-table-container">
        <div class="admin-table-title">
          <i class="fas fa-money-bill-wave"></i> Withdrawal Requests
          <div style="margin-left: auto; display: flex; gap: 10px;">
            <select id="filterWithdrawals" class="admin-input" style="width: 150px;" onchange="loadWithdrawals()">
              <option value="all">All Status</option>
              <option value="pending">Pending</option>
              <option value="processing">Processing</option>
              <option value="approved">Approved</option>
              <option value="rejected">Rejected</option>
            </select>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Amount</th>
              <th>Method</th>
              <th>Account</th>
              <th>Status</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="withdrawalsTable">
            <tr><td colspan="7" style="text-align: center; padding: 40px;">Loading withdrawals...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- CHATS SECTION -->
    <div id="chatsSection" style="display: none;">
      <div class="admin-table-container">
        <div class="admin-table-title">
          <i class="fas fa-comments"></i> Live Chats
          <div style="margin-left: auto;">
            <button class="admin-btn admin-btn-info" onclick="loadChats()">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Last Message</th>
              <th>Unread</th>
              <th>Status</th>
              <th>Last Active</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="chatsTable">
            <tr><td colspan="6" style="text-align: center; padding: 40px;">Loading chats...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- BADAK NUMBERS SECTION -->
    <div id="badakSection" style="display: none;">
      <div class="admin-table-container">
        <div class="admin-table-title">
          <i class="fab fa-whatsapp"></i> Badak Numbers
          <div style="margin-left: auto; display: flex; gap: 10px;">
            <input type="text" id="searchBadak" class="admin-input" placeholder="Search number..." style="width: 200px;">
            <button class="admin-btn admin-btn-success" onclick="showModal('addBadakModal')">
              <i class="fas fa-plus"></i> Add Manually
            </button>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>Phone Number</th>
              <th>User</th>
              <th>Code</th>
              <th>Status</th>
              <th>Activated</th>
              <th>Expires</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="badakTable">
            <tr><td colspan="7" style="text-align: center; padding: 40px;">Loading badak numbers...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- REFERRALS SECTION -->
    <div id="referralsSection" style="display: none;">
      <div class="admin-table-container">
        <div class="admin-table-title">
          <i class="fas fa-user-friends"></i> Referral History
          <div style="margin-left: auto;">
            <button class="admin-btn admin-btn-success" onclick="exportReferrals()">
              <i class="fas fa-download"></i> Export
            </button>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>Referrer</th>
              <th>Referred User</th>
              <th>Bonus</th>
              <th>Status</th>
              <th>Date</th>
              <th>IP</th>
            </tr>
          </thead>
          <tbody id="referralsTable">
            <tr><td colspan="6" style="text-align: center; padding: 40px;">Loading referrals...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- BROADCAST SECTION -->
    <div id="broadcastSection" style="display: none;">
      <div class="admin-table-container">
        <div class="admin-table-title">
          <i class="fas fa-bullhorn"></i> Send Broadcast Message
        </div>
        <div style="padding: 20px;">
          <div class="admin-input-group">
            <label class="admin-label">Title</label>
            <input type="text" id="broadcastTitle" class="admin-input" placeholder="Important Announcement">
          </div>
          
          <div class="admin-input-group">
            <label class="admin-label">Message</label>
            <textarea id="broadcastMessage" class="admin-textarea" placeholder="Type your broadcast message here..."></textarea>
          </div>
          
          <div class="admin-input-group">
            <label class="admin-label">Target Users</label>
            <select id="broadcastTarget" class="admin-input">
              <option value="all">All Users</option>
              <option value="active">Active Users (last 7 days)</option>
              <option value="inactive">Inactive Users (30+ days)</option>
              <option value="with_balance">Users with balance > Rp10.000</option>
              <option value="no_balance">Users with zero balance</option>
            </select>
          </div>
          
          <div class="admin-input-group">
            <label>
              <input type="checkbox" id="broadcastUrgent"> Mark as Urgent (Red badge)
            </label>
            <label style="margin-left: 20px;">
              <input type="checkbox" id="broadcastAction"> Include Action Button
            </label>
          </div>
          
          <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="admin-btn admin-btn-success" onclick="sendBroadcast()" style="flex: 1;">
              <i class="fas fa-paper-plane"></i> Send Broadcast
            </button>
            <button class="admin-btn admin-btn-warning" onclick="previewBroadcast()">
              <i class="fas fa-eye"></i> Preview
            </button>
          </div>
        </div>
      </div>
      
      <!-- BROADCAST HISTORY -->
      <div class="admin-table-container" style="margin-top: 30px;">
        <div class="admin-table-title">
          <i class="fas fa-history"></i> Broadcast History
        </div>
        <table>
          <thead>
            <tr>
              <th>Title</th>
              <th>Target</th>
              <th>Sent</th>
              <th>Read Rate</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="broadcastHistory">
            <tr><td colspan="5" style="text-align: center; padding: 40px;">Loading history...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- SETTINGS SECTION -->
    <div id="settingsSection" style="display: none;">
      <div class="admin-table-container">
        <div class="admin-table-title">
          <i class="fas fa-cog"></i> System Settings
        </div>
        <div style="padding: 20px;">
          <!-- SETTINGS FORM -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
            <!-- LEFT COLUMN -->
            <div>
              <h3 style="margin-bottom: 20px; color: white;">General Settings</h3>
              
              <div class="admin-input-group">
                <label class="admin-label">Minimum Withdrawal</label>
                <input type="number" id="minWithdrawal" class="admin-input" value="10000">
              </div>
              
              <div class="admin-input-group">
                <label class="admin-label">Referral Bonus (Referrer)</label>
                <input type="number" id="referrerBonus" class="admin-input" value="250">
              </div>
              
              <div class="admin-input-group">
                <label class="admin-label">Referral Bonus (Referred)</label>
                <input type="number" id="referredBonus" class="admin-input" value="100">
              </div>
              
              <div class="admin-input-group">
                <label class="admin-label">Badak Duration (Hours)</label>
                <input type="number" id="badakDuration" class="admin-input" value="24">
              </div>
            </div>
            
            <!-- RIGHT COLUMN -->
            <div>
              <h3 style="margin-bottom: 20px; color: white;">Security & Limits</h3>
              
              <div class="admin-input-group">
                <label class="admin-label">Max Withdrawals Per Day</label>
                <input type="number" id="maxWithdrawals" class="admin-input" value="3">
              </div>
              
              <div class="admin-input-group">
                <label class="admin-label">Max Balance Limit</label>
                <input type="number" id="maxBalance" class="admin-input" value="5000000">
              </div>
              
              <div class="admin-input-group">
                <label class="admin-label">Auto-Withdraw Threshold</label>
                <input type="number" id="autoWithdrawThreshold" class="admin-input" value="100000">
                <small style="color: rgba(255,255,255,0.5);">Auto-approve if below this amount</small>
              </div>
              
              <div class="admin-input-group">
                <label class="admin-label">Maintenance Mode</label>
                <div style="margin-top: 10px;">
                  <label style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="maintenanceMode">
                    Enable Maintenance Mode
                  </label>
                </div>
              </div>
            </div>
          </div>
          
          <!-- SAVE BUTTON -->
          <div style="margin-top: 30px; text-align: center;">
            <button class="admin-btn admin-btn-success" onclick="saveSettings()" style="padding: 12px 30px; font-size: 16px;">
              <i class="fas fa-save"></i> Save All Settings
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ========== MODALS ========== -->

<!-- CHAT MODAL -->
<div id="chatModal" class="admin-modal">
  <div class="admin-modal-content admin-chat-modal">
    <div class="admin-chat-header">
      <div class="admin-chat-user">
        <div class="admin-chat-avatar" id="chatUserAvatar">U</div>
        <div class="admin-chat-info">
          <h4 id="chatUserName">User Name</h4>
          <p id="chatUserEmail">user@email.com</p>
          <p id="chatUserStatus" style="font-size: 11px;">‚óè Online</p>
        </div>
      </div>
    </div>
    
    <div class="admin-chat-messages" id="chatMessagesArea">
      <!-- Messages will be loaded here -->
    </div>
    
    <div class="admin-chat-input">
      <textarea id="adminChatInput" placeholder="Type your reply..." onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendAdminMessage(); }"></textarea>
      <button class="admin-btn admin-btn-success" onclick="sendAdminMessage()" style="height: 50px; width: 50px; border-radius: 12px;">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
    
    <div style="padding: 15px; background: rgba(0,0,0,0.3); display: flex; justify-content: space-between;">
      <button class="admin-btn" onclick="closeModal('chatModal')">
        Close Chat
      </button>
      <button class="admin-btn admin-btn-danger" onclick="closeChat()">
        <i class="fas fa-ban"></i> Close Conversation
      </button>
    </div>
  </div>
</div>

<!-- WITHDRAWAL APPROVAL MODAL -->
<div id="withdrawalModal" class="admin-modal">
  <div class="admin-modal-content">
    <div class="admin-modal-header">
      <h3 class="admin-modal-title">
        <i class="fas fa-money-bill-wave"></i> Process Withdrawal
      </h3>
      <button class="admin-modal-close" onclick="closeModal('withdrawalModal')">&times;</button>
    </div>
    
    <div class="admin-input-group">
      <label class="admin-label">User</label>
      <div id="withdrawalUserInfo" style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 10px;">
        Loading...
      </div>
    </div>
    
    <div class="admin-input-group">
      <label class="admin-label">Amount</label>
      <div id="withdrawalAmountInfo" style="font-size: 24px; font-weight: 900; color: #FBBF24;">Rp0</div>
    </div>
    
    <div class="admin-input-group">
      <label class="admin-label">Method & Account</label>
      <div id="withdrawalMethodInfo" style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 10px;">
        Loading...
      </div>
    </div>
    
    <div class="admin-input-group">
      <label class="admin-label">Status</label>
      <select id="withdrawalStatus" class="admin-input">
        <option value="pending">Pending</option>
        <option value="processing">Processing</option>
        <option value="approved">Approved</option>
        <option value="rejected">Rejected</option>
      </select>
    </div>
    
    <div class="admin-input-group">
      <label class="admin-label">Admin Notes</label>
      <textarea id="withdrawalNotes" class="admin-textarea" placeholder="Add notes for the user..."></textarea>
    </div>
    
    <div class="admin-input-group">
      <label class="admin-label">Rejection Reason (if rejected)</label>
      <input type="text" id="rejectionReason" class="admin-input" placeholder="Reason for rejection...">
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 25px;">
      <button class="admin-btn admin-btn-success" onclick="processWithdrawal('approve')" style="flex: 1;">
        <i class="fas fa-check"></i> Approve
      </button>
      <button class="admin-btn admin-btn-warning" onclick="processWithdrawal('processing')" style="flex: 1;">
        <i class="fas fa-cog"></i> Mark as Processing
      </button>
      <button class="admin-btn admin-btn-danger" onclick="processWithdrawal('reject')" style="flex: 1;">
        <i class="fas fa-times"></i> Reject
      </button>
    </div>
    
    <input type="hidden" id="currentWithdrawalId">
  </div>
</div>

<!-- ADD BALANCE MODAL -->
<div id="addBalanceModal" class="admin-modal">
  <div class="admin-modal-content">
    <div class="admin-modal-header">
      <h3 class="admin-modal-title">
        <i class="fas fa-plus-circle"></i> Add Balance to User
      </h3>
      <button class="admin-modal-close" onclick="closeModal('addBalanceModal')">&times;</button>
    </div>
    
    <div class="admin-input-group">
      <label class="admin-label">Select User</label>
      <select id="balanceUserSelect" class="admin-input">
        <option value="">Loading users...</option>
      </select>
    </div>
    
    <div class="admin-input-group">
      <label class="admin-label">Amount (Rp)</label>
      <input type="number" id="balanceAmount" class="admin-input" placeholder="Enter amount">
    </div>
    
    <div class="admin-input-group">
      <label class="admin-label">Reason</label>
      <select id="balanceReason" class="admin-input">
        <option value="bonus">Bonus</option>
        <option value="referral">Referral Bonus</option>
        <option value="refund">Refund</option>
        <option value="correction">Balance Correction</option>
        <option value="promo">Promotional Bonus</option>
        <option value="other">Other</option>
      </select>
    </div>
    
    <div class="admin-input-group">
      <label class="admin-label">Notes</label>
      <textarea id="balanceNotes" class="admin-textarea" placeholder="Add notes..."></textarea>
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 25px;">
      <button class="admin-btn admin-btn-success" onclick="addUserBalance()" style="flex: 1;">
        <i class="fas fa-check"></i> Add Balance
      </button>
      <button class="admin-btn" onclick="closeModal('addBalanceModal')" style="flex: 1;">
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- BROADCAST PREVIEW MODAL -->
<div id="broadcastPreviewModal" class="admin-modal">
  <div class="admin-modal-content">
    <div class="admin-modal-header">
      <h3 class="admin-modal-title">
        <i class="fas fa-eye"></i> Broadcast Preview
      </h3>
      <button class="admin-modal-close" onclick="closeModal('broadcastPreviewModal')">&times;</button>
    </div>
    
    <div style="background: linear-gradient(135deg, #1e293b, #0f172a); border-radius: 15px; padding: 25px; margin: 20px 0; border: 2px solid #25D366;">
      <div style="text-align: center; font-size: 48px; color: #25D366; margin-bottom: 20px;">
        <i class="fas fa-bullhorn"></i>
      </div>
      <h3 id="previewTitle" style="text-align: center; margin-bottom: 15px; color: white;">Broadcast Title</h3>
      <div id="previewMessage" style="color: rgba(255,255,255,0.9); line-height: 1.6; white-space: pre-line;">
        Broadcast message will appear here...
      </div>
      <div id="previewAction" style="text-align: center; margin-top: 25px; display: none;">
        <button style="background: #25D366; color: white; border: none; padding: 12px 30px; border-radius: 10px; font-weight: 600; cursor: pointer;">
          <i class="fas fa-external-link-alt"></i> Take Action
        </button>
      </div>
    </div>
    
    <div style="color: rgba(255,255,255,0.7); font-size: 12px; text-align: center; margin-top: 20px;">
      This is how the broadcast will appear to users.
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 25px;">
      <button class="admin-btn admin-btn-success" onclick="sendBroadcastNow()" style="flex: 1;">
        <i class="fas fa-paper-plane"></i> Send Now
      </button>
      <button class="admin-btn" onclick="closeModal('broadcastPreviewModal')" style="flex: 1;">
        Edit Again
      </button>
    </div>
  </div>
</div>

<!-- ADD BADAK MODAL -->
<div id="addBadakModal" class="admin-modal">
  <div class="admin-modal-content">
    <div class="admin-modal-header">
      <h3 class="admin-modal-title">
        <i class="fab fa-whatsapp"></i> Add Badak Number Manually
      </h3>
      <button class="admin-modal-close" onclick="closeModal('addBadakModal')">&times;</button>
    </div>
    
    <div class="admin-input-group">
      <label class="admin-label">Select User</label>
      <select id="badakUserSelect" class="admin-input">
        <option value="">Loading users...</option>
      </select>
    </div>
    
    <div class="admin-input-group">
      <label class="admin-label">Phone Number</label>
      <input type="text" id="badakPhoneNumber" class="admin-input" placeholder="62812xxxxxxx">
    </div>
    
    <div class="admin-input-group">
      <label class="admin-label">Badak Code</label>
      <input type="text" id="badakCode" class="admin-input" placeholder="BADAK-XXXXXX" value="BADAK-ADMIN">
    </div>
    
    <div class="admin-input-group">
      <label class="admin-label">Duration (Hours)</label>
      <input type="number" id="badakDurationInput" class="admin-input" value="24">
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 25px;">
      <button class="admin-btn admin-btn-success" onclick="addManualBadak()" style="flex: 1;">
        <i class="fas fa-check"></i> Add Badak
      </button>
      <button class="admin-btn" onclick="closeModal('addBadakModal')" style="flex: 1;">
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- ========== JAVASCRIPT ========== -->
<script>
// ========== FIREBASE CONFIG ==========
const firebaseConfig = {
  apiKey: "AIzaSyCf230zCliSZ9EYLByMnmflqw8sOz328Uc",
  authDomain: "database-cupz.firebaseapp.com",
  projectId: "database-cupz",
  storageBucket: "database-cupz.firebasestorage.app",
  messagingSenderId: "343357519412",
  appId: "1:343357519412:web:dce862636c7c459e6a3c61"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ========== GLOBAL VARIABLES ==========
let currentAdmin = null;
let currentChatId = null;
let currentWithdrawalId = null;
let broadcastData = {};

// ========== NOTIFICATION FUNCTION ==========
function showNotification(type, message) {
  const notification = document.createElement('div');
  notification.className = `admin-notification notification-${type}`;
  notification.innerHTML = `
    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
    <span>${message}</span>
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideIn 0.3s reverse';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// ========== MODAL FUNCTIONS ==========
function showModal(modalId) {
  document.getElementById(modalId).style.display = 'flex';
}

function closeModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
}

// ========== NAVIGATION FUNCTIONS ==========
function showSection(section) {
  // Hide all sections
  const sections = ['dashboard', 'users', 'withdrawals', 'chats', 'badak', 'referrals', 'broadcast', 'settings'];
  sections.forEach(sec => {
    document.getElementById(sec + 'Section').style.display = 'none';
    document.querySelector(`[onclick="showSection('${sec}')"]`).classList.remove('active');
  });
  
  // Show selected section
  document.getElementById(section + 'Section').style.display = 'block';
  document.querySelector(`[onclick="showSection('${section}')"]`).classList.add('active');
  
  // Update title
  const titles = {
    dashboard: 'Dashboard',
    users: 'User Management',
    withdrawals: 'Withdrawal Requests',
    chats: 'Live Chat Support',
    badak: 'Badak Numbers',
    referrals: 'Referral System',
    broadcast: 'Broadcast Messages',
    settings: 'System Settings'
  };
  
  document.getElementById('sectionTitle').textContent = titles[section];
  document.getElementById('sectionSubtitle').textContent = `Manage ${titles[section].toLowerCase()}`;
  
  // Load section data
  if (section === 'dashboard') loadDashboard();
  if (section === 'users') loadUsers();
  if (section === 'withdrawals') loadWithdrawals();
  if (section === 'chats') loadChats();
  if (section === 'badak') loadBadakNumbers();
  if (section === 'referrals') loadReferrals();
  if (section === 'broadcast') loadBroadcastHistory();
}

// ========== AUTH FUNCTIONS ==========
function checkAdminAuth() {
  auth.onAuthStateChanged(async (user) => {
    if (user) {
      currentAdmin = user;
      
      const userDoc = await db.collection('users').doc(user.uid).get();
      if (userDoc.exists) {
        const userData = userDoc.data();
        if (userData.role !== 'admin') {
          window.location.href = 'index.html';
          return;
        }
        
        // Update admin info
        document.getElementById('adminName').textContent = userData.email.split('@')[0];
        document.getElementById('adminEmail').textContent = user.email;
        document.getElementById('adminAvatar').textContent = user.email.charAt(0).toUpperCase();
        
        // Load dashboard
        loadDashboard();
        setupRealtimeListeners();
        
      } else {
        window.location.href = 'index.html';
      }
    } else {
      window.location.href = 'index.html';
    }
  });
}

function adminLogout() {
  if (confirm('Yakin ingin logout?')) {
    auth.signOut().then(() => {
      window.location.href = 'index.html';
    });
  }
}

// ========== DASHBOARD FUNCTIONS ==========
async function loadDashboard() {
  try {
    // Load total users
    const usersSnapshot = await db.collection('users').where('role', '==', 'user').get();
    document.getElementById('totalUsers').textContent = usersSnapshot.size;
    
    // Calculate total balance
    let totalBalance = 0;
    usersSnapshot.forEach(doc => {
      totalBalance += doc.data().balance || 0;
    });
    document.getElementById('totalBalance').textContent = 'Rp' + totalBalance.toLocaleString('id-ID');
    
    // Load pending withdrawals
    const withdrawalsSnapshot = await db.collection('withdrawals').where('status', '==', 'pending').get();
    document.getElementById('pendingWithdrawals').textContent = withdrawalsSnapshot.size;
    
    // Load unread chats
    const chatsSnapshot = await db.collection('chats').where('adminUnread', '>', 0).get();
    document.getElementById('unreadChats').textContent = chatsSnapshot.size;
    
    // Update badges
    document.getElementById('usersBadge').textContent = usersSnapshot.size;
    document.getElementById('withdrawalsBadge').textContent = withdrawalsSnapshot.size;
    document.getElementById('chatsBadge').textContent = chatsSnapshot.size;
    
    // Load recent activities
    loadRecentActivities();
    
  } catch (error) {
    console.error('Dashboard error:', error);
    showNotification('error', 'Failed to load dashboard data');
  }
}

async function loadRecentActivities() {
  try {
    const activitiesSnapshot = await db.collection('activities')
      .orderBy('timestamp', 'desc')
      .limit(10)
      .get();
    
    const activitiesDiv = document.getElementById('recentActivities');
    
    if (activitiesSnapshot.empty) {
      activitiesDiv.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">No recent activities</div>';
      return;
    }
    
    let html = '<table><thead><tr><th>User</th><th>Activity</th><th>Time</th><th>IP</th></tr></thead><tbody>';
    
    activitiesSnapshot.forEach(doc => {
      const data = doc.data();
      const time = data.timestamp?.toDate() || new Date();
      const timeAgo = getTimeAgo(time);
      
      html += `
        <tr>
          <td>${data.userEmail || 'Unknown'}</td>
          <td>${data.description || 'No description'}</td>
          <td>${timeAgo}</td>
          <td>${data.ip || 'Unknown'}</td>
        </tr>
      `;
    });
    
    html += '</tbody></table>';
    activitiesDiv.innerHTML = html;
    
  } catch (error) {
    console.error('Activities error:', error);
  }
}

// ========== USER MANAGEMENT ==========
async function loadUsers() {
  try {
    const usersSnapshot = await db.collection('users')
      .where('role', '==', 'user')
      .orderBy('createdAt', 'desc')
      .get();
    
    const tbody = document.getElementById('usersTable');
    let html = '';
    
    if (usersSnapshot.empty) {
      html = '<tr><td colspan="6" style="text-align: center; padding: 40px;">No users found</td></tr>';
    } else {
      usersSnapshot.forEach(doc => {
        const user = doc.data();
        const createdAt = user.createdAt?.toDate() || new Date();
        const lastLogin = user.lastLogin?.toDate() || new Date();
        
        html += `
          <tr>
            <td>
              <strong>${user.email}</strong><br>
              <small style="color: rgba(255,255,255,0.5);">ID: ${doc.id.substring(0, 8)}...</small>
            </td>
            <td>
              <strong style="color: #FBBF24;">Rp${(user.balance || 0).toLocaleString('id-ID')}</strong>
            </td>
            <td>${user.referralCount || 0}</td>
            <td><span class="status-badge ${user.status === 'active' ? 'status-active' : 'status-inactive'}">${user.status || 'inactive'}</span></td>
            <td>${createdAt.toLocaleDateString('id-ID')}<br><small>${getTimeAgo(lastLogin)} ago</small></td>
            <td>
              <button class="admin-btn admin-btn-info" onclick="viewUserDetails('${doc.id}')">
                <i class="fas fa-eye"></i>
              </button>
              <button class="admin-btn admin-btn-success" onclick="addBalanceToUser('${doc.id}', '${user.email}')">
                <i class="fas fa-plus"></i>
              </button>
              ${user.status === 'active' ? 
                `<button class="admin-btn admin-btn-danger" onclick="toggleUserStatus('${doc.id}', 'suspend')">
                  <i class="fas fa-ban"></i>
                </button>` :
                `<button class="admin-btn admin-btn-success" onclick="toggleUserStatus('${doc.id}', 'activate')">
                  <i class="fas fa-check"></i>
                </button>`
              }
            </td>
          </tr>
        `;
      });
    }
    
    tbody.innerHTML = html;
    
  } catch (error) {
    console.error('Users error:', error);
    showNotification('error', 'Failed to load users');
  }
}

function viewUserDetails(userId) {
  // Implement user details view
  showNotification('info', `Viewing user ${userId.substring(0, 8)}...`);
}

function addBalanceToUser(userId, email) {
  const select = document.getElementById('balanceUserSelect');
  select.innerHTML = `<option value="${userId}">${email} (Current Balance: Loading...)</option>`;
  
  // Load current balance
  db.collection('users').doc(userId).get().then(doc => {
    if (doc.exists) {
      const balance = doc.data().balance || 0;
      select.innerHTML = `<option value="${userId}">${email} (Current Balance: Rp${balance.toLocaleString('id-ID')})</option>`;
    }
  });
  
  showModal('addBalanceModal');
}

async function toggleUserStatus(userId, action) {
  const newStatus = action === 'suspend' ? 'suspended' : 'active';
  const confirmMsg = action === 'suspend' ? 
    'Are you sure you want to suspend this user?' : 
    'Are you sure you want to activate this user?';
  
  if (!confirm(confirmMsg)) return;
  
  try {
    await db.collection('users').doc(userId).update({
      status: newStatus,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // Log activity
    await db.collection('admin_activities').add({
      adminId: currentAdmin.uid,
      adminEmail: currentAdmin.email,
      action: action === 'suspend' ? 'user_suspended' : 'user_activated',
      targetUserId: userId,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    showNotification('success', `User ${action === 'suspend' ? 'suspended' : 'activated'} successfully`);
    loadUsers();
    
  } catch (error) {
    console.error('Toggle status error:', error);
    showNotification('error', 'Failed to update user status');
  }
}

// ========== WITHDRAWAL MANAGEMENT ==========
async function loadWithdrawals() {
  const filter = document.getElementById('filterWithdrawals').value;
  
  try {
    let query = db.collection('withdrawals').orderBy('timestamp', 'desc');
    
    if (filter !== 'all') {
      query = query.where('status', '==', filter);
    }
    
    const withdrawalsSnapshot = await query.get();
    const tbody = document.getElementById('withdrawalsTable');
    let html = '';
    
    if (withdrawalsSnapshot.empty) {
      html = '<tr><td colspan="7" style="text-align: center; padding: 40px;">No withdrawals found</td></tr>';
    } else {
      withdrawalsSnapshot.forEach(doc => {
        const withdrawal = doc.data();
        const date = withdrawal.timestamp?.toDate() || new Date();
        
        // Get status badge
        let statusClass = 'status-pending';
        let statusText = 'Pending';
        
        if (withdrawal.status === 'approved') {
          statusClass = 'status-approved';
          statusText = 'Approved';
        } else if (withdrawal.status === 'rejected') {
          statusClass = 'status-rejected';
          statusText = 'Rejected';
        } else if (withdrawal.status === 'processing') {
          statusClass = 'status-pending';
          statusText = 'Processing';
        }
        
        html += `
          <tr>
            <td>
              <strong>${withdrawal.userEmail || 'Unknown'}</strong><br>
              <small>ID: ${withdrawal.userId?.substring(0, 8) || 'N/A'}...</small>
            </td>
            <td><strong style="color: #FBBF24;">Rp${(withdrawal.amount || 0).toLocaleString('id-ID')}</strong></td>
            <td>${withdrawal.method || 'Unknown'}</td>
            <td>${withdrawal.accountInfo || 'N/A'}</td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>${date.toLocaleDateString('id-ID')}<br><small>${date.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'})}</small></td>
            <td>
              <button class="admin-btn admin-btn-info" onclick="viewWithdrawal('${doc.id}')">
                <i class="fas fa-eye"></i>
              </button>
              <button class="admin-btn admin-btn-success" onclick="processWithdrawalModal('${doc.id}')">
                <i class="fas fa-cog"></i>
              </button>
            </td>
          </tr>
        `;
      });
    }
    
    tbody.innerHTML = html;
    
  } catch (error) {
    console.error('Withdrawals error:', error);
    showNotification('error', 'Failed to load withdrawals');
  }
}

function viewWithdrawal(withdrawalId) {
  // Implement detailed view
  showNotification('info', `Viewing withdrawal ${withdrawalId.substring(0, 8)}...`);
}

function processWithdrawalModal(withdrawalId) {
  currentWithdrawalId = withdrawalId;
  
  // Load withdrawal data
  db.collection('withdrawals').doc(withdrawalId).get().then(doc => {
    if (doc.exists) {
      const data = doc.data();
      
      // Update modal
      document.getElementById('withdrawalUserInfo').innerHTML = `
        <strong>${data.userEmail || 'Unknown'}</strong><br>
        <small>User ID: ${data.userId?.substring(0, 12) || 'N/A'}</small>
      `;
      
      document.getElementById('withdrawalAmountInfo').textContent = `Rp${(data.amount || 0).toLocaleString('id-ID')}`;
      
      document.getElementById('withdrawalMethodInfo').innerHTML = `
        <strong>Method:</strong> ${data.method || 'Unknown'}<br>
        <strong>Account:</strong> ${data.accountInfo || 'N/A'}<br>
        <strong>Name:</strong> ${data.accountName || 'N/A'}
      `;
      
      document.getElementById('withdrawalStatus').value = data.status || 'pending';
      document.getElementById('currentWithdrawalId').value = withdrawalId;
      
      showModal('withdrawalModal');
    }
  });
}

async function processWithdrawal(action) {
  if (!currentWithdrawalId) return;
  
  const status = action === 'approve' ? 'approved' : 
                action === 'reject' ? 'rejected' : 
                action === 'processing' ? 'processing' : 'pending';
  
  const notes = document.getElementById('withdrawalNotes').value;
  const rejectionReason = document.getElementById('rejectionReason').value;
  
  try {
    const withdrawalDoc = await db.collection('withdrawals').doc(currentWithdrawalId).get();
    const withdrawalData = withdrawalDoc.data();
    
    // Update withdrawal
    await db.collection('withdrawals').doc(currentWithdrawalId).update({
      status: status,
      processedAt: firebase.firestore.FieldValue.serverTimestamp(),
      processedBy: currentAdmin.email,
      adminNotes: notes,
      rejectionReason: rejectionReason
    });
    
    // If rejected, return balance to user
    if (status === 'rejected') {
      await db.collection('users').doc(withdrawalData.userId).update({
        balance: firebase.firestore.FieldValue.increment(withdrawalData.amount)
      });
    }
    
    // Send notification to user
    await db.collection('notifications').add({
      userId: withdrawalData.userId,
      userEmail: withdrawalData.userEmail,
      type: 'withdrawal_processed',
      title: 'üí∞ Withdrawal Update',
      message: `Your withdrawal of Rp${withdrawalData.amount.toLocaleString('id-ID')} has been ${status}. ${rejectionReason ? 'Reason: ' + rejectionReason : ''}`,
      read: false,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // Log admin activity
    await db.collection('admin_activities').add({
      adminId: currentAdmin.uid,
      adminEmail: currentAdmin.email,
      action: 'withdrawal_processed',
      withdrawalId: currentWithdrawalId,
      status: status,
      amount: withdrawalData.amount,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    showNotification('success', `Withdrawal ${status} successfully`);
    closeModal('withdrawalModal');
    loadWithdrawals();
    loadDashboard();
    
  } catch (error) {
    console.error('Process withdrawal error:', error);
    showNotification('error', 'Failed to process withdrawal');
  }
}

// ========== CHAT MANAGEMENT ==========
async function loadChats() {
  try {
    const chatsSnapshot = await db.collection('chats')
      .orderBy('lastMessageTime', 'desc')
      .get();
    
    const tbody = document.getElementById('chatsTable');
    let html = '';
    
    if (chatsSnapshot.empty) {
      html = '<tr><td colspan="6" style="text-align: center; padding: 40px;">No active chats</td></tr>';
    } else {
      chatsSnapshot.forEach(doc => {
        const chat = doc.data();
        const lastTime = chat.lastMessageTime?.toDate() || new Date();
        const unread = chat.adminUnread || 0;
        
        html += `
          <tr>
            <td>
              <strong>${chat.userEmail || 'Unknown'}</strong><br>
              <small>${chat.userName || 'User'}</small>
            </td>
            <td>${(chat.lastMessage || 'No messages').substring(0, 50)}${chat.lastMessage?.length > 50 ? '...' : ''}</td>
            <td>${unread > 0 ? `<span class="admin-menu-badge">${unread}</span>` : '0'}</td>
            <td><span class="status-badge ${chat.status === 'active' ? 'status-active' : 'status-pending'}">${chat.status || 'pending'}</span></td>
            <td>${getTimeAgo(lastTime)} ago</td>
            <td>
              <button class="admin-btn admin-btn-info" onclick="openChat('${doc.id}')">
                <i class="fas fa-comment"></i> Reply
              </button>
              <button class="admin-btn admin-btn-danger" onclick="closeChatAdmin('${doc.id}')">
                <i class="fas fa-ban"></i> Close
              </button>
            </td>
          </tr>
        `;
      });
    }
    
    tbody.innerHTML = html;
    
  } catch (error) {
    console.error('Chats error:', error);
    showNotification('error', 'Failed to load chats');
  }
}

async function openChat(chatId) {
  currentChatId = chatId;
  
  try {
    const chatDoc = await db.collection('chats').doc(chatId).get();
    if (chatDoc.exists) {
      const chatData = chatDoc.data();
      
      // Update chat modal
      document.getElementById('chatUserName').textContent = chatData.userName || 'User';
      document.getElementById('chatUserEmail').textContent = chatData.userEmail || 'Unknown';
      document.getElementById('chatUserAvatar').textContent = chatData.userEmail?.charAt(0).toUpperCase() || 'U';
      
      // Load messages
      await loadChatMessages(chatId);
      
      // Mark as read
      await db.collection('chats').doc(chatId).update({
        adminUnread: 0
      });
      
      showModal('chatModal');
      
      // Setup real-time listener for new messages
      setupChatListener(chatId);
    }
  } catch (error) {
    console.error('Open chat error:', error);
    showNotification('error', 'Failed to open chat');
  }
}

async function loadChatMessages(chatId) {
  try {
    const messagesSnapshot = await db.collection('chat_messages')
      .where('chatId', '==', chatId)
      .orderBy('timestamp', 'asc')
      .get();
    
    const messagesDiv = document.getElementById('chatMessagesArea');
    let html = '';
    
    if (messagesSnapshot.empty) {
      html = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 40px;">No messages yet</div>';
    } else {
      messagesSnapshot.forEach(doc => {
        const msg = doc.data();
        const time = msg.timestamp?.toDate() || new Date();
        const isAdmin = msg.senderRole === 'admin';
        
        html += `
          <div class="admin-message ${isAdmin ? 'admin-message-admin' : 'admin-message-user'}">
            <div><strong>${isAdmin ? 'You' : (msg.senderName || 'User')}</strong></div>
            <div>${msg.message}</div>
            <div style="font-size: 11px; opacity: 0.7; margin-top: 5px;">
              ${time.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'})}
            </div>
          </div>
        `;
      });
    }
    
    messagesDiv.innerHTML = html;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
  } catch (error) {
    console.error('Load messages error:', error);
  }
}

function setupChatListener(chatId) {
  // Real-time listener for new messages
  db.collection('chat_messages')
    .where('chatId', '==', chatId)
    .orderBy('timestamp', 'desc')
    .limit(1)
    .onSnapshot((snapshot) => {
      if (!snapshot.empty) {
        loadChatMessages(chatId);
        
        // Update unread count
        db.collection('chats').doc(chatId).update({
          adminUnread: 0
        });
      }
    });
}

async function sendAdminMessage() {
  if (!currentChatId) return;
  
  const input = document.getElementById('adminChatInput');
  const message = input.value.trim();
  
  if (!message) return;
  
  try {
    // Send message
    await db.collection('chat_messages').add({
      chatId: currentChatId,
      senderId: currentAdmin.uid,
      senderName: 'Admin',
      senderRole: 'admin',
      message: message,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      read: false
    });
    
    // Update chat
    await db.collection('chats').doc(currentChatId).update({
      lastMessage: message,
      lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
      status: 'active',
      userUnread: firebase.firestore.FieldValue.increment(1)
    });
    
    // Clear input
    input.value = '';
    
    // Reload messages
    await loadChatMessages(currentChatId);
    
  } catch (error) {
    console.error('Send message error:', error);
    showNotification('error', 'Failed to send message');
  }
}

async function closeChat() {
  if (!currentChatId) return;
  
  if (!confirm('Close this conversation?')) return;
  
  try {
    await db.collection('chats').doc(currentChatId).update({
      status: 'closed',
      closedAt: firebase.firestore.FieldValue.serverTimestamp(),
      closedBy: currentAdmin.email
    });
    
    closeModal('chatModal');
    showNotification('success', 'Chat closed successfully');
    loadChats();
    
  } catch (error) {
    console.error('Close chat error:', error);
    showNotification('error', 'Failed to close chat');
  }
}

async function closeChatAdmin(chatId) {
  if (!confirm('Close this chat?')) return;
  
  try {
    await db.collection('chats').doc(chatId).update({
      status: 'closed',
      closedAt: firebase.firestore.FieldValue.serverTimestamp(),
      closedBy: currentAdmin.email
    });
    
    showNotification('success', 'Chat closed successfully');
    loadChats();
    
  } catch (error) {
    console.error('Close chat error:', error);
  }
}

// ========== BADAK MANAGEMENT ==========
async function loadBadakNumbers() {
  try {
    const badakSnapshot = await db.collection('badak_numbers')
      .orderBy('activatedAt', 'desc')
      .limit(50)
      .get();
    
    const tbody = document.getElementById('badakTable');
    let html = '';
    
    if (badakSnapshot.empty) {
      html = '<tr><td colspan="7" style="text-align: center; padding: 40px;">No badak numbers found</td></tr>';
    } else {
      badakSnapshot.forEach(doc => {
        const badak = doc.data();
        const activated = badak.activatedAt?.toDate() || new Date();
        const expires = badak.expiredAt?.toDate() || new Date();
        const now = new Date();
        const isExpired = expires < now;
        
        html += `
          <tr>
            <td><strong>${badak.phone || 'Unknown'}</strong></td>
            <td>${badak.userId?.substring(0, 8) || 'N/A'}...</td>
            <td><code>${badak.code || 'N/A'}</code></td>
            <td><span class="status-badge ${isExpired ? 'status-inactive' : 'status-active'}">${isExpired ? 'Expired' : 'Active'}</span></td>
            <td>${activated.toLocaleDateString('id-ID')}<br><small>${activated.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'})}</small></td>
            <td>${expires.toLocaleDateString('id-ID')}<br><small>${expires.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'})}</small></td>
            <td>
              <button class="admin-btn admin-btn-danger" onclick="deleteBadak('${doc.id}')">
                <i class="fas fa-trash"></i>
              </button>
              <button class="admin-btn admin-btn-success" onclick="extendBadak('${doc.id}')">
                <i class="fas fa-clock"></i>
              </button>
            </td>
          </tr>
        `;
      });
    }
    
    tbody.innerHTML = html;
    
  } catch (error) {
    console.error('Badak numbers error:', error);
    showNotification('error', 'Failed to load badak numbers');
  }
}

async function deleteBadak(badakId) {
  if (!confirm('Delete this badak number?')) return;
  
  try {
    await db.collection('badak_numbers').doc(badakId).delete();
    showNotification('success', 'Badak number deleted');
    loadBadakNumbers();
  } catch (error) {
    console.error('Delete badak error:', error);
    showNotification('error', 'Failed to delete badak number');
  }
}

async function extendBadak(badakId) {
  try {
    const badakDoc = await db.collection('badak_numbers').doc(badakId).get();
    if (badakDoc.exists) {
      const expires = new Date();
      expires.setHours(expires.getHours() + 24);
      
      await db.collection('badak_numbers').doc(badakId).update({
        expiredAt: expires
      });
      
      showNotification('success', 'Badak extended for 24 hours');
      loadBadakNumbers();
    }
  } catch (error) {
    console.error('Extend badak error:', error);
    showNotification('error', 'Failed to extend badak');
  }
}

async function addManualBadak() {
  const userId = document.getElementById('badakUserSelect').value;
  const phone = document.getElementById('badakPhoneNumber').value;
  const code = document.getElementById('badakCode').value;
  const duration = parseInt(document.getElementById('badakDurationInput').value);
  
  if (!userId || !phone || !code) {
    showNotification('error', 'Please fill all fields');
    return;
  }
  
  try {
    const expires = new Date();
    expires.setHours(expires.getHours() + duration);
    
    await db.collection('badak_numbers').add({
      userId: userId,
      phone: phone,
      code: code,
      activatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      expiredAt: expires,
      status: 'active',
      addedBy: currentAdmin.email,
      isManual: true
    });
    
    // Update user stats
    await db.collection('users').doc(userId).update({
      totalBadak: firebase.firestore.FieldValue.increment(1)
    });
    
    closeModal('addBadakModal');
    showNotification('success', 'Badak number added manually');
    loadBadakNumbers();
    
  } catch (error) {
    console.error('Add manual badak error:', error);
    showNotification('error', 'Failed to add badak number');
  }
}

// ========== REFERRAL MANAGEMENT ==========
async function loadReferrals() {
  try {
    const referralsSnapshot = await db.collection('referrals')
      .orderBy('timestamp', 'desc')
      .limit(50)
      .get();
    
    const tbody = document.getElementById('referralsTable');
    let html = '';
    
    if (referralsSnapshot.empty) {
      html = '<tr><td colspan="6" style="text-align: center; padding: 40px;">No referrals found</td></tr>';
    } else {
      referralsSnapshot.forEach(doc => {
        const ref = doc.data();
        const date = ref.timestamp?.toDate() || new Date();
        
        html += `
          <tr>
            <td>${ref.referrerEmail || 'Unknown'}</td>
            <td>${ref.referredEmail || 'Unknown'}</td>
            <td>
              Referrer: <strong style="color: #25D366;">+Rp${ref.referrerBonus || 250}</strong><br>
              Referred: <strong style="color: #FBBF24;">+Rp${ref.referredBonus || 100}</strong>
            </td>
            <td><span class="status-badge status-approved">Success</span></td>
            <td>${date.toLocaleDateString('id-ID')}</td>
            <td><small>${ref.ip || 'N/A'}</small></td>
          </tr>
        `;
      });
    }
    
    tbody.innerHTML = html;
    
  } catch (error) {
    console.error('Referrals error:', error);
    showNotification('error', 'Failed to load referrals');
  }
}

// ========== BROADCAST FUNCTIONS ==========
function previewBroadcast() {
  const title = document.getElementById('broadcastTitle').value;
  const message = document.getElementById('broadcastMessage').value;
  const hasAction = document.getElementById('broadcastAction').checked;
  
  if (!title || !message) {
    showNotification('error', 'Please fill title and message');
    return;
  }
  
  broadcastData = {
    title: title,
    message: message,
    target: document.getElementById('broadcastTarget').value,
    urgent: document.getElementById('broadcastUrgent').checked,
    hasAction: hasAction
  };
  
  document.getElementById('previewTitle').textContent = title;
  document.getElementById('previewMessage').textContent = message;
  document.getElementById('previewAction').style.display = hasAction ? 'block' : 'none';
  
  showModal('broadcastPreviewModal');
}

async function sendBroadcastNow() {
  if (!broadcastData.title || !broadcastData.message) return;
  
  try {
    // Get target users
    let usersQuery = db.collection('users').where('role', '==', 'user');
    
    if (broadcastData.target === 'active') {
      const weekAgo = new Date();
      weekAgo.setDate(weekAgo.getDate() - 7);
      // Note: Need to add lastLogin field to users collection
    } else if (broadcastData.target === 'with_balance') {
      usersQuery = usersQuery.where('balance', '>', 10000);
    } else if (broadcastData.target === 'no_balance') {
      usersQuery = usersQuery.where('balance', '==', 0);
    }
    
    const usersSnapshot = await usersQuery.get();
    const batch = db.batch();
    
    // Create broadcast record
    const broadcastRef = db.collection('broadcasts').doc();
    batch.set(broadcastRef, {
      title: broadcastData.title,
      message: broadcastData.message,
      target: broadcastData.target,
      urgent: broadcastData.urgent,
      hasAction: broadcastData.hasAction,
      sentBy: currentAdmin.email,
      sentAt: firebase.firestore.FieldValue.serverTimestamp(),
      totalUsers: usersSnapshot.size
    });
    
    // Send notifications to all users
    usersSnapshot.forEach(userDoc => {
      const notificationRef = db.collection('notifications').doc();
      batch.set(notificationRef, {
        userId: userDoc.id,
        userEmail: userDoc.data().email,
        type: 'broadcast',
        title: broadcastData.title,
        message: broadcastData.message,
        urgent: broadcastData.urgent,
        hasAction: broadcastData.hasAction,
        read: false,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        broadcastId: broadcastRef.id
      });
    });
    
    await batch.commit();
    
    closeModal('broadcastPreviewModal');
    closeModal('broadcastModal');
    
    showNotification('success', `Broadcast sent to ${usersSnapshot.size} users`);
    
    // Log activity
    await db.collection('admin_activities').add({
      adminId: currentAdmin.uid,
      adminEmail: currentAdmin.email,
      action: 'broadcast_sent',
      title: broadcastData.title,
      target: broadcastData.target,
      userCount: usersSnapshot.size,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    
  } catch (error) {
    console.error('Send broadcast error:', error);
    showNotification('error', 'Failed to send broadcast');
  }
}

async function loadBroadcastHistory() {
  try {
    const broadcastsSnapshot = await db.collection('broadcasts')
      .orderBy('sentAt', 'desc')
      .limit(20)
      .get();
    
    const tbody = document.getElementById('broadcastHistory');
    let html = '';
    
    if (broadcastsSnapshot.empty) {
      html = '<tr><td colspan="5" style="text-align: center; padding: 40px;">No broadcast history</td></tr>';
    } else {
      broadcastsSnapshot.forEach(doc => {
        const broadcast = doc.data();
        const sentAt = broadcast.sentAt?.toDate() || new Date();
        
        html += `
          <tr>
            <td>
              <strong>${broadcast.title}</strong><br>
              <small>${broadcast.message.substring(0, 50)}...</small>
            </td>
            <td>${broadcast.target || 'all'}</td>
            <td>${sentAt.toLocaleDateString('id-ID')}<br><small>${sentAt.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'})}</small></td>
            <td>${broadcast.totalUsers || 0} users</td>
            <td>
              <button class="admin-btn admin-btn-info" onclick="viewBroadcastStats('${doc.id}')">
                <i class="fas fa-chart-bar"></i>
              </button>
              <button class="admin-btn" onclick="resendBroadcast('${doc.id}')">
                <i class="fas fa-redo"></i>
              </button>
            </td>
          </tr>
        `;
      });
    }
    
    tbody.innerHTML = html;
    
  } catch (error) {
    console.error('Broadcast history error:', error);
  }
}

// ========== SETTINGS FUNCTIONS ==========
async function saveSettings() {
  const settings = {
    minWithdrawal: parseInt(document.getElementById('minWithdrawal').value) || 10000,
    referrerBonus: parseInt(document.getElementById('referrerBonus').value) || 250,
    referredBonus: parseInt(document.getElementById('referredBonus').value) || 100,
    badakDuration: parseInt(document.getElementById('badakDuration').value) || 24,
    maxWithdrawals: parseInt(document.getElementById('maxWithdrawals').value) || 3,
    maxBalance: parseInt(document.getElementById('maxBalance').value) || 5000000,
    autoWithdrawThreshold: parseInt(document.getElementById('autoWithdrawThreshold').value) || 100000,
    maintenanceMode: document.getElementById('maintenanceMode').checked
  };
  
  try {
    await db.collection('settings').doc('system').set(settings, { merge: true });
    
    showNotification('success', 'Settings saved successfully');
    
    // Log activity
    await db.collection('admin_activities').add({
      adminId: currentAdmin.uid,
      adminEmail: currentAdmin.email,
      action: 'settings_updated',
      settings: settings,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    
  } catch (error) {
    console.error('Save settings error:', error);
    showNotification('error', 'Failed to save settings');
  }
}

// ========== ADD BALANCE FUNCTION ==========
async function addUserBalance() {
  const userId = document.getElementById('balanceUserSelect').value;
  const amount = parseInt(document.getElementById('balanceAmount').value);
  const reason = document.getElementById('balanceReason').value;
  const notes = document.getElementById('balanceNotes').value;
  
  if (!userId || !amount || amount <= 0) {
    showNotification('error', 'Please enter valid amount');
    return;
  }
  
  try {
    // Add balance to user
    await db.collection('users').doc(userId).update({
      balance: firebase.firestore.FieldValue.increment(amount),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // Record transaction
    await db.collection('admin_transactions').add({
      adminId: currentAdmin.uid,
      adminEmail: currentAdmin.email,
      userId: userId,
      amount: amount,
      type: 'balance_addition',
      reason: reason,
      notes: notes,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // Send notification to user
    const userDoc = await db.collection('users').doc(userId).get();
    const userEmail = userDoc.data().email;
    
    await db.collection('notifications').add({
      userId: userId,
      userEmail: userEmail,
      type: 'balance_added',
      title: 'üí∞ Balance Added',
      message: `Admin added Rp${amount.toLocaleString('id-ID')} to your balance. Reason: ${reason}. ${notes ? 'Notes: ' + notes : ''}`,
      read: false,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    closeModal('addBalanceModal');
    showNotification('success', `Added Rp${amount.toLocaleString('id-ID')} to user`);
    
    // Reset form
    document.getElementById('balanceAmount').value = '';
    document.getElementById('balanceNotes').value = '';
    
  } catch (error) {
    console.error('Add balance error:', error);
    showNotification('error', 'Failed to add balance');
  }
}

// ========== UTILITY FUNCTIONS ==========
function getTimeAgo(date) {
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  
  if (diffMins < 1) return 'just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  
  return date.toLocaleDateString('id-ID');
}

function setupRealtimeListeners() {
  // Real-time updates for dashboard
  setInterval(loadDashboard, 30000); // Update every 30 seconds
  
  // Listen for new withdrawals
  db.collection('withdrawals')
    .where('status', '==', 'pending')
    .onSnapshot((snapshot) => {
      document.getElementById('withdrawalsBadge').textContent = snapshot.size;
      document.getElementById('pendingWithdrawals').textContent = snapshot.size;
    });
  
  // Listen for new chats
  db.collection('chats')
    .where('adminUnread', '>', 0)
    .onSnapshot((snapshot) => {
      document.getElementById('chatsBadge').textContent = snapshot.size;
      document.getElementById('unreadChats').textContent = snapshot.size;
    });
}

// ========== EXPORT FUNCTIONS ==========
async function exportUsers() {
  try {
    const usersSnapshot = await db.collection('users')
      .where('role', '==', 'user')
      .get();
    
    let csv = 'Email,Balance,Referrals,Status,Joined\n';
    
    usersSnapshot.forEach(doc => {
      const user = doc.data();
      const joined = user.createdAt?.toDate() || new Date();
      
      csv += `"${user.email}",${user.balance || 0},${user.referralCount || 0},"${user.status || 'inactive'}","${joined.toISOString()}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `users_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    
    showNotification('success', 'Users exported successfully');
    
  } catch (error) {
    console.error('Export error:', error);
    showNotification('error', 'Failed to export users');
  }
}

async function exportReferrals() {
  try {
    const referralsSnapshot = await db.collection('referrals').get();
    
    let csv = 'Referrer Email,Referred Email,Referrer Bonus,Referred Bonus,Date,IP\n';
    
    referralsSnapshot.forEach(doc => {
      const ref = doc.data();
      const date = ref.timestamp?.toDate() || new Date();
      
      csv += `"${ref.referrerEmail || ''}","${ref.referredEmail || ''}",${ref.referrerBonus || 250},${ref.referredBonus || 100},"${date.toISOString()}","${ref.ip || ''}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `referrals_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    
    showNotification('success', 'Referrals exported successfully');
    
  } catch (error) {
    console.error('Export error:', error);
    showNotification('error', 'Failed to export referrals');
  }
}

// ========== INITIALIZE ==========
document.addEventListener('DOMContentLoaded', function() {
  checkAdminAuth();
  
  // Load users for select dropdowns
  loadUsersForSelect();
});

async function loadUsersForSelect() {
  try {
    const usersSnapshot = await db.collection('users')
      .where('role', '==', 'user')
      .orderBy('email')
      .get();
    
    let userOptions = '<option value="">Select user...</option>';
    let badakOptions = '<option value="">Select user...</option>';
    
    usersSnapshot.forEach(doc => {
      const user = doc.data();
      const option = `<option value="${doc.id}">${user.email} (Balance: Rp${(user.balance || 0).toLocaleString('id-ID')})</option>`;
      userOptions += option;
      badakOptions += option;
    });
    
    document.getElementById('balanceUserSelect').innerHTML = userOptions;
    document.getElementById('badakUserSelect').innerHTML = badakOptions;
    
  } catch (error) {
    console.error('Load users for select error:', error);
  }
}

// ========== UNIMPLEMENTED FUNCTIONS (PLACEHOLDERS) ==========
function viewBroadcastStats(broadcastId) {
  showNotification('info', `Viewing stats for broadcast ${broadcastId.substring(0, 8)}...`);
}

function resendBroadcast(broadcastId) {
  showNotification('info', `Resending broadcast ${broadcastId.substring(0, 8)}...`);
}

function sendBroadcast() {
  previewBroadcast();
}
</script>

</body>
</html>